#!/usr/bin/env node

var fs = require( "fs" ),
    cwd = process.cwd(),
    args = [].slice.call( process.argv, 2 ),
    path = require( "path" ),
    exec = require( "exec" ),
    server = require( "../squarespace-server" ), 
    config = path.join( cwd, "template.conf" ),
    forever = path.join( __dirname, "../", "node_modules", "forever", "bin", "forever" ),
    startup = path.join( __dirname, "../squarespace-startup.js" )
    functions = require( "../lib/functions" ),
    foreverIdx = args.indexOf( "--forever" );

// Start with forever process
if ( foreverIdx !== -1 ) {
    functions.log( "Started server with forever" );

    // Splice --forever flag from the argument list
    args.splice( foreverIdx, 1 );

    // @todo: Utilize --uid in order to support sqs stop-server or something like that
    exec( (forever + " start " + startup + " " + args.join( " " ) + " --uid 'node-squarespace-server'"), function ( error, stdout ) {} );

// Standard node process
} else {
    config = ("" + fs.readFileSync( config ));
    config = JSON.parse( config );

    server.init( config, args );
}